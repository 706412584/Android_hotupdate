import{_ as _e,r as m,a as M,o as ve,M as w,c as $,b as V,f as l,w as t,g as s,q as ge,v as be,e as B,j as i,t as z,d as S,m as we,F as R,h as K,k as Ve,D as ye,y as L,E as p}from"./index-KNdCMb-d.js";const Ue={class:"patches"},xe={class:"card-header"},Ce={__name:"Patches",setup(he){const D=m(!1),q=m([]),x=m([]),C=m(null),y=m(!1),U=m(!1),h=m(!1),G=m(null),k=m(null),f=m([]),r=M({id:null,description:"",forceUpdate:!1,rolloutPercentage:100,status:"active"}),n=M({app_id:null,version:"",baseVersion:"",description:"",forceUpdate:!1}),v=M({page:1,limit:10,total:0});ve(()=>{H(),g()});const H=async()=>{try{const{data:o}=await w.getApps();x.value=o.filter(e=>e.review_status==="approved")}catch(o){console.error("加载应用列表失败:",o)}},g=async()=>{var o;try{D.value=!0;const e={page:v.page,limit:v.limit};C.value&&(e.app_id=C.value);const{data:d}=await w.getPatches(e);q.value=d.patches||[],v.total=((o=d.pagination)==null?void 0:o.total)||0}catch(e){console.error("加载补丁列表失败:",e)}finally{D.value=!1}},J=o=>o<1024?o+" B":o<1024*1024?(o/1024).toFixed(2)+" KB":(o/1024/1024).toFixed(2)+" MB",O=o=>{r.id=o.id,r.description=o.description,r.forceUpdate=o.force_update===1,r.rolloutPercentage=o.rollout_percentage,r.status=o.status,y.value=!0},Q=async()=>{try{await w.updatePatch(r.id,{description:r.description,forceUpdate:r.forceUpdate,rolloutPercentage:r.rolloutPercentage,status:r.status}),p.success("更新成功"),y.value=!1,g()}catch(o){console.error("更新失败:",o)}},W=async o=>{try{await L.confirm("确定要删除这个补丁吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await w.deletePatch(o.id),p.success("删除成功"),g()}catch(e){e!=="cancel"&&console.error("删除失败:",e)}},X=()=>{if(x.value.length===0){p.warning("请先创建应用");return}n.app_id=null,n.version="",n.baseVersion="",n.description="",n.forceUpdate=!1,k.value=null,U.value=!0},Y=o=>{k.value=o.raw},Z=()=>{p.warning("只能上传一个文件")},ee=o=>{f.value=o},le=async o=>{if(f.value.length===0){p.warning("请先选择补丁");return}try{let e="",d="";o==="enable"?(e=`确定要启用选中的 ${f.value.length} 个补丁吗？`,d="enable"):o==="disable"?(e=`确定要停用选中的 ${f.value.length} 个补丁吗？`,d="disable"):o==="delete"&&(e=`确定要删除选中的 ${f.value.length} 个补丁吗？此操作不可恢复！`,d="delete"),await L.confirm(e,"批量操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const b=f.value.map(u=>u.id);if(d==="delete")await w.post("/patches/batch-delete",{ids:b}),p.success("批量删除成功");else{const u=d==="enable"?"active":"inactive";await w.post("/patches/batch-update-status",{ids:b,status:u}),p.success(`批量${d==="enable"?"启用":"停用"}成功`)}f.value=[],g()}catch(e){e!=="cancel"&&(p.error("操作失败"),console.error(e))}},te=async()=>{var o,e;if(!n.app_id){p.warning("请选择应用");return}if(!n.version||!n.baseVersion){p.warning("请填写版本号和基础版本号");return}if(!k.value){p.warning("请选择补丁文件");return}try{h.value=!0;const d=new FormData;d.append("file",k.value),d.append("app_id",n.app_id),d.append("version",n.version),d.append("baseVersion",n.baseVersion),d.append("description",n.description),d.append("forceUpdate",n.forceUpdate),await w.uploadPatch(d,b=>{const u=Math.round(b.loaded*100/b.total);console.log("上传进度:",u+"%")}),p.success("补丁上传成功"),U.value=!1,g()}catch(d){console.error("上传失败:",d),p.error("上传失败: "+(((e=(o=d.response)==null?void 0:o.data)==null?void 0:e.error)||d.message))}finally{h.value=!1}};return(o,e)=>{const d=s("arrow-down"),b=s("el-icon"),u=s("el-button"),F=s("el-dropdown-item"),ae=s("el-dropdown-menu"),oe=s("el-dropdown"),E=s("el-option"),T=s("el-select"),ne=s("el-space"),_=s("el-table-column"),de=s("el-tag"),se=s("el-table"),re=s("el-pagination"),ie=s("el-card"),P=s("el-input"),c=s("el-form-item"),N=s("el-switch"),ue=s("el-slider"),j=s("el-radio"),pe=s("el-radio-group"),A=s("el-form"),I=s("el-dialog"),ce=s("el-upload"),me=ge("loading");return V(),$("div",Ue,[l(ie,null,{header:t(()=>[S("div",xe,[e[20]||(e[20]=S("span",null,"补丁列表",-1)),l(ne,null,{default:t(()=>[f.value.length>0?(V(),B(oe,{key:0,onCommand:le},{dropdown:t(()=>[l(ae,null,{default:t(()=>[l(F,{command:"enable"},{default:t(()=>[...e[16]||(e[16]=[i("批量启用",-1)])]),_:1}),l(F,{command:"disable"},{default:t(()=>[...e[17]||(e[17]=[i("批量停用",-1)])]),_:1}),l(F,{command:"delete",divided:""},{default:t(()=>[...e[18]||(e[18]=[i("批量删除",-1)])]),_:1})]),_:1})]),default:t(()=>[l(u,{type:"primary"},{default:t(()=>[i(" 批量操作 ("+z(f.value.length)+") ",1),l(b,{class:"el-icon--right"},{default:t(()=>[l(d)]),_:1})]),_:1})]),_:1})):we("",!0),l(T,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=a=>C.value=a),placeholder:"筛选应用",clearable:"",onChange:g,style:{width:"200px"}},{default:t(()=>[(V(!0),$(R,null,K(x.value,a=>(V(),B(E,{key:a.id,label:a.app_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(u,{type:"primary",onClick:X},{default:t(()=>[l(b,null,{default:t(()=>[l(Ve(ye))]),_:1}),e[19]||(e[19]=i(" 上传补丁 ",-1))]),_:1})]),_:1})])]),default:t(()=>[be((V(),B(se,{data:q.value,onSelectionChange:ee},{default:t(()=>[l(_,{type:"selection",width:"55"}),l(_,{prop:"version",label:"版本",width:"120"}),l(_,{prop:"base_version",label:"基础版本",width:"120"}),l(_,{prop:"description",label:"描述","show-overflow-tooltip":""}),l(_,{prop:"file_size",label:"大小",width:"100"},{default:t(({row:a})=>[i(z(J(a.file_size)),1)]),_:1}),l(_,{prop:"download_count",label:"下载次数",width:"100"}),l(_,{prop:"status",label:"状态",width:"100"},{default:t(({row:a})=>[l(de,{type:a.status==="active"?"success":"info"},{default:t(()=>[i(z(a.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(_,{prop:"created_at",label:"创建时间",width:"180"}),l(_,{label:"操作",width:"200",fixed:"right"},{default:t(({row:a})=>[l(u,{size:"small",onClick:fe=>O(a)},{default:t(()=>[...e[21]||(e[21]=[i("编辑",-1)])]),_:1},8,["onClick"]),l(u,{size:"small",type:"danger",onClick:fe=>W(a)},{default:t(()=>[...e[22]||(e[22]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,D.value]]),l(re,{"current-page":v.page,"onUpdate:currentPage":e[1]||(e[1]=a=>v.page=a),"page-size":v.limit,"onUpdate:pageSize":e[2]||(e[2]=a=>v.limit=a),total:v.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:g,onSizeChange:g,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"])]),_:1}),l(I,{modelValue:y.value,"onUpdate:modelValue":e[8]||(e[8]=a=>y.value=a),title:"编辑补丁",width:"500px"},{footer:t(()=>[l(u,{onClick:e[7]||(e[7]=a=>y.value=!1)},{default:t(()=>[...e[25]||(e[25]=[i("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:Q},{default:t(()=>[...e[26]||(e[26]=[i("确定",-1)])]),_:1})]),default:t(()=>[l(A,{model:r,"label-width":"100px"},{default:t(()=>[l(c,{label:"描述"},{default:t(()=>[l(P,{modelValue:r.description,"onUpdate:modelValue":e[3]||(e[3]=a=>r.description=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),l(c,{label:"强制更新"},{default:t(()=>[l(N,{modelValue:r.forceUpdate,"onUpdate:modelValue":e[4]||(e[4]=a=>r.forceUpdate=a)},null,8,["modelValue"])]),_:1}),l(c,{label:"灰度百分比"},{default:t(()=>[l(ue,{modelValue:r.rolloutPercentage,"onUpdate:modelValue":e[5]||(e[5]=a=>r.rolloutPercentage=a),min:0,max:100},null,8,["modelValue"])]),_:1}),l(c,{label:"状态"},{default:t(()=>[l(pe,{modelValue:r.status,"onUpdate:modelValue":e[6]||(e[6]=a=>r.status=a)},{default:t(()=>[l(j,{label:"active"},{default:t(()=>[...e[23]||(e[23]=[i("启用",-1)])]),_:1}),l(j,{label:"inactive"},{default:t(()=>[...e[24]||(e[24]=[i("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(I,{modelValue:U.value,"onUpdate:modelValue":e[15]||(e[15]=a=>U.value=a),title:"上传补丁",width:"600px"},{footer:t(()=>[l(u,{onClick:e[14]||(e[14]=a=>U.value=!1)},{default:t(()=>[...e[29]||(e[29]=[i("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:te,loading:h.value},{default:t(()=>[i(z(h.value?"上传中...":"确定上传"),1)]),_:1},8,["loading"])]),default:t(()=>[l(A,{model:n,"label-width":"100px"},{default:t(()=>[l(c,{label:"选择应用",required:""},{default:t(()=>[l(T,{modelValue:n.app_id,"onUpdate:modelValue":e[9]||(e[9]=a=>n.app_id=a),placeholder:"请选择应用",style:{width:"100%"}},{default:t(()=>[(V(!0),$(R,null,K(x.value,a=>(V(),B(E,{key:a.id,label:a.app_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"补丁版本",required:""},{default:t(()=>[l(P,{modelValue:n.version,"onUpdate:modelValue":e[10]||(e[10]=a=>n.version=a),placeholder:"例如: 1.0.1"},null,8,["modelValue"])]),_:1}),l(c,{label:"基础版本",required:""},{default:t(()=>[l(P,{modelValue:n.baseVersion,"onUpdate:modelValue":e[11]||(e[11]=a=>n.baseVersion=a),placeholder:"例如: 1.0.0"},null,8,["modelValue"])]),_:1}),l(c,{label:"描述"},{default:t(()=>[l(P,{modelValue:n.description,"onUpdate:modelValue":e[12]||(e[12]=a=>n.description=a),type:"textarea",rows:3,placeholder:"补丁说明"},null,8,["modelValue"])]),_:1}),l(c,{label:"强制更新"},{default:t(()=>[l(N,{modelValue:n.forceUpdate,"onUpdate:modelValue":e[13]||(e[13]=a=>n.forceUpdate=a)},null,8,["modelValue"])]),_:1}),l(c,{label:"补丁文件",required:""},{default:t(()=>[l(ce,{ref_key:"uploadRef",ref:G,"auto-upload":!1,limit:1,accept:".zip","on-change":Y,"on-exceed":Z},{tip:t(()=>[...e[28]||(e[28]=[S("div",{class:"el-upload__tip"},"只能上传 zip 文件，且不超过 100MB",-1)])]),default:t(()=>[l(u,{type:"primary"},{default:t(()=>[...e[27]||(e[27]=[i("选择文件",-1)])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Pe=_e(Ce,[["__scopeId","data-v-a1c7ef78"]]);export{Pe as default};
