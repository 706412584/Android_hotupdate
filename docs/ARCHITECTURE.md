# æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“ æ•´ä½“æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å±‚ (App)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ MainActivity â”‚  â”‚ UpdateManagerâ”‚  â”‚ PatchApplier â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çƒ­æ›´æ–° SDK (update)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              HotUpdateHelper (å•ä¾‹)                       â”‚   â”‚
â”‚  â”‚  - è¡¥ä¸åº”ç”¨   - ç‰ˆæœ¬æ£€æµ‹   - æ ¼å¼éªŒè¯   - å®‰å…¨éªŒè¯      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚DexPatcherâ”‚  â”‚SoPatcher â”‚  â”‚ResPatcherâ”‚  â”‚SecurityMgrâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¡¥ä¸ç”Ÿæˆå¼•æ“ (patch-core)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  PatchGenerator                           â”‚   â”‚
â”‚  â”‚  - APK è§£æ   - å·®å¼‚æ¯”è¾ƒ   - è¡¥ä¸æ‰“åŒ…   - ç­¾ååŠ å¯†      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ApkParser â”‚  â”‚DexDiffer â”‚  â”‚ResDiffer â”‚  â”‚PatchPackerâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Native å¼•æ“ (patch-native)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              NativePatchEngine (JNI)                      â”‚   â”‚
â”‚  â”‚  - BsDiff ç®—æ³•   - é«˜æ€§èƒ½å¤„ç†   - è‡ªåŠ¨é™çº§              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ BsDiff   â”‚  â”‚ BsPatch  â”‚  â”‚ JKSè§£æ  â”‚                      â”‚
â”‚  â”‚ (C/C++)  â”‚  â”‚ (C/C++)  â”‚  â”‚ (C/C++)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡ç«¯ (patch-server)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Web ç®¡ç†åå° + RESTful API                   â”‚   â”‚
â”‚  â”‚  - è¡¥ä¸ç®¡ç†   - ç°åº¦å‘å¸ƒ   - ç»Ÿè®¡åˆ†æ   - ç”¨æˆ·ç®¡ç†      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æ¨¡å—è®¾è®¡

### 1. update æ¨¡å—ï¼ˆçƒ­æ›´æ–° SDKï¼‰

**èŒè´£**: è¡¥ä¸åº”ç”¨ã€åŠ è½½ã€éªŒè¯

#### æ ¸å¿ƒç±»

```java
HotUpdateHelper (å•ä¾‹)
â”œâ”€â”€ applyPatch()           // åº”ç”¨è¡¥ä¸
â”œâ”€â”€ loadPatchIfNeeded()    // åŠ è½½å·²åº”ç”¨çš„è¡¥ä¸
â”œâ”€â”€ clearPatch()           // æ¸…é™¤è¡¥ä¸
â””â”€â”€ validatePatch()        // éªŒè¯è¡¥ä¸

DexPatcher
â”œâ”€â”€ patchDex()             // DEX çƒ­æ›´æ–°
â””â”€â”€ loadDex()              // åŠ è½½ DEX

SoPatcher
â”œâ”€â”€ patchSo()              // SO åº“çƒ­æ›´æ–°
â””â”€â”€ loadSo()               // åŠ è½½ SO

ResourcePatcher
â”œâ”€â”€ patchResource()        // èµ„æºçƒ­æ›´æ–°
â””â”€â”€ loadResource()         // åŠ è½½èµ„æº

SecurityManager
â”œâ”€â”€ encryptPatch()         // åŠ å¯†è¡¥ä¸
â”œâ”€â”€ decryptPatch()         // è§£å¯†è¡¥ä¸
â””â”€â”€ verifySignature()      // éªŒè¯ç­¾å
```

#### æ•°æ®æµ

```
è¡¥ä¸æ–‡ä»¶ (patch.zip)
    â†“
[æ ¼å¼éªŒè¯] â†’ æ£€æŸ¥ ZIP é­”æ•°ã€patch.json
    â†“
[åŒ…åéªŒè¯] â†’ ç¡®ä¿è¡¥ä¸ä¸åº”ç”¨åŒ¹é…
    â†“
[ç­¾åéªŒè¯] â†’ éªŒè¯è¡¥ä¸ç­¾åï¼ˆå¯é€‰ï¼‰
    â†“
[è§£å¯†] â†’ AES è§£å¯†ï¼ˆå¦‚æœåŠ å¯†ï¼‰
    â†“
[è§£å‹] â†’ æå– DEXã€SOã€èµ„æºæ–‡ä»¶
    â†“
[åº”ç”¨è¡¥ä¸]
    â”œâ”€â”€ DexPatcher â†’ ä¿®æ”¹ ClassLoader
    â”œâ”€â”€ SoPatcher â†’ ä¿®æ”¹ nativeLibraryPathElements
    â””â”€â”€ ResourcePatcher â†’ æ›¿æ¢ AssetManager
    â†“
[ä¿å­˜çŠ¶æ€] â†’ è®°å½•è¡¥ä¸ä¿¡æ¯ï¼Œä¸‹æ¬¡å¯åŠ¨åŠ è½½
```

---

### 2. patch-core æ¨¡å—ï¼ˆè¡¥ä¸ç”Ÿæˆå¼•æ“ï¼‰

**èŒè´£**: APK è§£æã€å·®å¼‚æ¯”è¾ƒã€è¡¥ä¸æ‰“åŒ…

#### æ ¸å¿ƒç±»

```java
PatchGenerator (æ„å»ºå™¨æ¨¡å¼)
â”œâ”€â”€ parse()                // è§£æ APK
â”œâ”€â”€ compare()              // æ¯”è¾ƒå·®å¼‚
â”œâ”€â”€ pack()                 // æ‰“åŒ…è¡¥ä¸
â””â”€â”€ sign()                 // ç­¾åè¡¥ä¸

ApkParser
â”œâ”€â”€ parseManifest()        // è§£æ AndroidManifest.xml
â”œâ”€â”€ parseDex()             // è§£æ DEX æ–‡ä»¶
â””â”€â”€ parseResources()       // è§£æèµ„æºæ–‡ä»¶

DexDiffer
â”œâ”€â”€ compareDex()           // æ¯”è¾ƒ DEX å·®å¼‚
â””â”€â”€ generatePatchDex()     // ç”Ÿæˆè¡¥ä¸ DEX

ResourceDiffer
â”œâ”€â”€ compareResources()     // æ¯”è¾ƒèµ„æºå·®å¼‚
â””â”€â”€ compareAssets()        // æ¯”è¾ƒ Assets å·®å¼‚

PatchPacker
â”œâ”€â”€ pack()                 // æ‰“åŒ…è¡¥ä¸
â””â”€â”€ addFile()              // æ·»åŠ æ–‡ä»¶åˆ°è¡¥ä¸

JarSigner
â”œâ”€â”€ sign()                 // ç­¾åè¡¥ä¸
â””â”€â”€ verify()               // éªŒè¯ç­¾å
```

#### è¡¥ä¸ç”Ÿæˆæµç¨‹

```
åŸºçº¿ APK (v1.0)  +  æ–°ç‰ˆ APK (v1.1)
    â†“                    â†“
[è§£æ APK]          [è§£æ APK]
    â†“                    â†“
ApkInfo (v1.0)      ApkInfo (v1.1)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
      [å·®å¼‚æ¯”è¾ƒ]
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â†“           â†“
[DEX å·®å¼‚]  [èµ„æºå·®å¼‚]
    â†“           â†“
DexDiffResult  ResourceDiffResult
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â†“
    [ç”Ÿæˆè¡¥ä¸å†…å®¹]
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â†“           â†“
patch.json   ä¿®æ”¹çš„æ–‡ä»¶
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â†“
    [æ‰“åŒ… ZIP]
          â†“
    patch.zip (æœªç­¾å)
          â†“
    [ç­¾å] (å¯é€‰)
          â†“
    patch.zip (å·²ç­¾å)
```

---

### 3. patch-native æ¨¡å—ï¼ˆNative å¼•æ“ï¼‰

**èŒè´£**: é«˜æ€§èƒ½å·®å¼‚ç®—æ³•ã€JKS è§£æ

#### æ ¸å¿ƒç»„ä»¶

```cpp
// BsDiff ç®—æ³•ï¼ˆå¢é‡æ›´æ–°ï¼‰
bsdiff.cpp
â”œâ”€â”€ bsdiff()               // ç”Ÿæˆå·®å¼‚æ–‡ä»¶
â””â”€â”€ bspatch()              // åº”ç”¨å·®å¼‚æ–‡ä»¶

// JKS è§£æå™¨
jks_parser.cpp
â”œâ”€â”€ parseKeyStore()        // è§£æ JKS æ–‡ä»¶
â”œâ”€â”€ getPrivateKey()        // è·å–ç§é’¥
â””â”€â”€ getCertificateChain()  // è·å–è¯ä¹¦é“¾

// JNI æ¥å£
jks_jni.cpp
â”œâ”€â”€ loadKeyStore()         // JNI: åŠ è½½ KeyStore
â”œâ”€â”€ getPrivateKey()        // JNI: è·å–ç§é’¥
â””â”€â”€ getCertificateChain()  // JNI: è·å–è¯ä¹¦é“¾
```

#### æ€§èƒ½ä¼˜åŒ–

- **å¤šçº¿ç¨‹å¤„ç†**: å¹¶è¡Œå¤„ç†å¤šä¸ª DEX æ–‡ä»¶
- **å†…å­˜æ˜ å°„**: ä½¿ç”¨ mmap å‡å°‘å†…å­˜æ‹·è´
- **æµå¼å¤„ç†**: å¤§æ–‡ä»¶æµå¼è¯»å–ï¼Œé¿å… OOM
- **è‡ªåŠ¨é™çº§**: Native ä¸å¯ç”¨æ—¶è‡ªåŠ¨ä½¿ç”¨ Java å®ç°

---

### 4. patch-server æ¨¡å—ï¼ˆæœåŠ¡ç«¯ï¼‰

**èŒè´£**: è¡¥ä¸ç®¡ç†ã€ç°åº¦å‘å¸ƒã€ç»Ÿè®¡åˆ†æ

#### æŠ€æœ¯æ ˆ

```
å‰ç«¯: Vue 3 + Element Plus + ECharts
åç«¯: Node.js + Express + SQLite/MySQL
è®¤è¯: JWT
æ–‡ä»¶: Multer
```

#### API è®¾è®¡

```
POST   /api/auth/login              # ç”¨æˆ·ç™»å½•
POST   /api/auth/register           # ç”¨æˆ·æ³¨å†Œ

GET    /api/apps                    # è·å–åº”ç”¨åˆ—è¡¨
POST   /api/apps                    # åˆ›å»ºåº”ç”¨
GET    /api/apps/:id                # è·å–åº”ç”¨è¯¦æƒ…

GET    /api/patches                 # è·å–è¡¥ä¸åˆ—è¡¨
POST   /api/patches                 # ä¸Šä¼ è¡¥ä¸
GET    /api/patches/:id             # è·å–è¡¥ä¸è¯¦æƒ…
PUT    /api/patches/:id             # æ›´æ–°è¡¥ä¸
DELETE /api/patches/:id             # åˆ é™¤è¡¥ä¸

GET    /api/check-update            # æ£€æŸ¥æ›´æ–°
GET    /api/download/:id            # ä¸‹è½½è¡¥ä¸

GET    /api/stats/dashboard         # ä»ªè¡¨æ¿ç»Ÿè®¡
GET    /api/stats/downloads         # ä¸‹è½½ç»Ÿè®¡
```

#### æ•°æ®åº“è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨
users
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ username (ç”¨æˆ·å)
â”œâ”€â”€ password (å¯†ç å“ˆå¸Œ)
â”œâ”€â”€ role (è§’è‰²: admin/user)
â””â”€â”€ created_at (åˆ›å»ºæ—¶é—´)

-- åº”ç”¨è¡¨
apps
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ app_id (åº”ç”¨ ID)
â”œâ”€â”€ name (åº”ç”¨åç§°)
â”œâ”€â”€ package_name (åŒ…å)
â”œâ”€â”€ user_id (æ‰€å±ç”¨æˆ·)
â””â”€â”€ created_at (åˆ›å»ºæ—¶é—´)

-- è¡¥ä¸è¡¨
patches
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ app_id (åº”ç”¨ ID)
â”œâ”€â”€ version (ç‰ˆæœ¬å·)
â”œâ”€â”€ base_version (åŸºçº¿ç‰ˆæœ¬)
â”œâ”€â”€ file_path (æ–‡ä»¶è·¯å¾„)
â”œâ”€â”€ file_size (æ–‡ä»¶å¤§å°)
â”œâ”€â”€ md5 (MD5 å“ˆå¸Œ)
â”œâ”€â”€ status (çŠ¶æ€: draft/published/archived)
â”œâ”€â”€ rollout_percentage (ç°åº¦ç™¾åˆ†æ¯”)
â”œâ”€â”€ download_count (ä¸‹è½½æ¬¡æ•°)
â””â”€â”€ created_at (åˆ›å»ºæ—¶é—´)

-- ä¸‹è½½è®°å½•è¡¨
downloads
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ patch_id (è¡¥ä¸ ID)
â”œâ”€â”€ device_id (è®¾å¤‡ ID)
â”œâ”€â”€ ip_address (IP åœ°å€)
â””â”€â”€ downloaded_at (ä¸‹è½½æ—¶é—´)
```

---

## ğŸ”„ æ ¸å¿ƒç®—æ³•

### 1. DEX çƒ­æ›´æ–°ç®—æ³•

**åŸç†**: ä¿®æ”¹ ClassLoader çš„ dexElements æ•°ç»„

```java
// 1. è·å– PathClassLoader
ClassLoader classLoader = context.getClassLoader();

// 2. åå°„è·å– pathList å­—æ®µ
Field pathListField = BaseDexClassLoader.class.getDeclaredField("pathList");
pathListField.setAccessible(true);
Object pathList = pathListField.get(classLoader);

// 3. åå°„è·å– dexElements å­—æ®µ
Field dexElementsField = pathList.getClass().getDeclaredField("dexElements");
dexElementsField.setAccessible(true);
Object[] oldDexElements = (Object[]) dexElementsField.get(pathList);

// 4. åŠ è½½è¡¥ä¸ DEX
DexFile patchDex = DexFile.loadDex(patchDexPath, ...);

// 5. åˆ›å»ºæ–°çš„ dexElementsï¼ˆè¡¥ä¸åœ¨å‰ï¼‰
Object[] newDexElements = new Object[oldDexElements.length + 1];
newDexElements[0] = patchDexElement;  // è¡¥ä¸ DEX
System.arraycopy(oldDexElements, 0, newDexElements, 1, oldDexElements.length);

// 6. æ›¿æ¢ dexElements
dexElementsField.set(pathList, newDexElements);
```

**å…³é”®ç‚¹**:
- è¡¥ä¸ DEX å¿…é¡»åœ¨æ•°ç»„å‰é¢ï¼ˆä¼˜å…ˆåŠ è½½ï¼‰
- ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶
- å·²åŠ è½½çš„ç±»æ— æ³•æ›¿æ¢ï¼ˆéœ€è¦é‡å¯ï¼‰

---

### 2. èµ„æºçƒ­æ›´æ–°ç®—æ³•

**åŸç†**: æ›¿æ¢ AssetManager

```java
// 1. åˆ›å»ºæ–°çš„ AssetManager
AssetManager newAssetManager = AssetManager.class.newInstance();

// 2. æ·»åŠ è¡¥ä¸èµ„æºè·¯å¾„
Method addAssetPath = AssetManager.class.getMethod("addAssetPath", String.class);
addAssetPath.invoke(newAssetManager, patchResourcePath);

// 3. æ·»åŠ åŸå§‹ APK è·¯å¾„ï¼ˆä½œä¸ºåŸºçº¿ï¼‰
addAssetPath.invoke(newAssetManager, apkPath);

// 4. æ›¿æ¢æ‰€æœ‰ Resources å¯¹è±¡çš„ AssetManager
// åŒ…æ‹¬ï¼šApplicationã€Activityã€ContextImpl ç­‰
replaceAssetManager(context, newAssetManager);
```

**å…³é”®ç‚¹**:
- `resources.arsc` å¿…é¡»ä½¿ç”¨ STORE æ¨¡å¼ï¼ˆä¸å‹ç¼©ï¼‰
- éœ€è¦é‡å¯ Activity æ‰èƒ½çœ‹åˆ°æ–°èµ„æº
- éœ€è¦æ›¿æ¢æ‰€æœ‰ Resources å¯¹è±¡

---

### 3. SO åº“çƒ­æ›´æ–°ç®—æ³•

**åŸç†**: ä¿®æ”¹ ClassLoader çš„ nativeLibraryPathElements

```java
// 1. è·å– PathClassLoader
ClassLoader classLoader = context.getClassLoader();

// 2. åå°„è·å– pathList å­—æ®µ
Field pathListField = BaseDexClassLoader.class.getDeclaredField("pathList");
pathListField.setAccessible(true);
Object pathList = pathListField.get(classLoader);

// 3. åå°„è·å– nativeLibraryPathElements å­—æ®µ
Field nativeLibraryPathElementsField = 
    pathList.getClass().getDeclaredField("nativeLibraryPathElements");
nativeLibraryPathElementsField.setAccessible(true);
Object[] oldElements = (Object[]) nativeLibraryPathElementsField.get(pathList);

// 4. åˆ›å»ºæ–°çš„ nativeLibraryPathElementsï¼ˆè¡¥ä¸åœ¨å‰ï¼‰
Object[] newElements = new Object[oldElements.length + 1];
newElements[0] = patchSoElement;  // è¡¥ä¸ SO
System.arraycopy(oldElements, 0, newElements, 1, oldElements.length);

// 5. æ›¿æ¢ nativeLibraryPathElements
nativeLibraryPathElementsField.set(pathList, newElements);
```

**å…³é”®ç‚¹**:
- è¡¥ä¸ SO å¿…é¡»åœ¨æ•°ç»„å‰é¢ï¼ˆä¼˜å…ˆåŠ è½½ï¼‰
- å·²åŠ è½½çš„ SO æ— æ³•æ›¿æ¢ï¼ˆéœ€è¦é‡å¯ï¼‰
- ä¸åŒ ABI éœ€è¦ä¸åŒçš„ SO æ–‡ä»¶

---

### 4. BsDiff å¢é‡ç®—æ³•

**åŸç†**: äºŒè¿›åˆ¶å·®å¼‚ç®—æ³•

```
æ—§æ–‡ä»¶: [A B C D E F]
æ–°æ–‡ä»¶: [A B X D E Y]

å·®å¼‚æ–‡ä»¶:
- ä¿æŒ: A B (offset: 0, length: 2)
- æ›¿æ¢: C â†’ X (offset: 2, length: 1)
- ä¿æŒ: D E (offset: 3, length: 2)
- æ›¿æ¢: F â†’ Y (offset: 5, length: 1)
```

**ä¼˜åŠ¿**:
- è¡¥ä¸æ–‡ä»¶å°ï¼ˆåªåŒ…å«å·®å¼‚ï¼‰
- é€‚åˆå¤§æ–‡ä»¶ï¼ˆå¦‚ DEXã€SOï¼‰
- å‹ç¼©ç‡é«˜ï¼ˆé€šå¸¸ 10-30%ï¼‰

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. ç­¾åéªŒè¯æµç¨‹

```
è¡¥ä¸æ–‡ä»¶ (patch.zip)
    â†“
[è¯»å–ç­¾åä¿¡æ¯]
    â”œâ”€â”€ META-INF/MANIFEST.MF
    â”œâ”€â”€ META-INF/CERT.SF
    â””â”€â”€ META-INF/CERT.RSA
    â†“
[è·å– APK ç­¾å]
    â””â”€â”€ PackageManager.getPackageInfo()
    â†“
[æ¯”å¯¹ç­¾å]
    â”œâ”€â”€ è¯ä¹¦é“¾åŒ¹é…ï¼Ÿ
    â”œâ”€â”€ ç­¾åç®—æ³•åŒ¹é…ï¼Ÿ
    â””â”€â”€ æ‘˜è¦éªŒè¯é€šè¿‡ï¼Ÿ
    â†“
[éªŒè¯ç»“æœ]
    â”œâ”€â”€ âœ… é€šè¿‡ â†’ ç»§ç»­åº”ç”¨
    â””â”€â”€ âŒ å¤±è´¥ â†’ æ‹’ç»å¹¶æ¸…é™¤
```

### 2. åŠ å¯†æµç¨‹

```
åŸå§‹è¡¥ä¸ (patch.zip)
    â†“
[ç”Ÿæˆå¯†é’¥]
    â”œâ”€â”€ æ–¹å¼1: ç”¨æˆ·å¯†ç  â†’ PBKDF2 â†’ AES Key
    â”œâ”€â”€ æ–¹å¼2: Android KeyStore â†’ AES Key
    â””â”€â”€ æ–¹å¼3: ZIP å¯†ç 
    â†“
[AES-256-GCM åŠ å¯†]
    â”œâ”€â”€ åŠ å¯†æ•°æ®
    â”œâ”€â”€ ç”Ÿæˆ IV (åˆå§‹åŒ–å‘é‡)
    â””â”€â”€ ç”Ÿæˆ Auth Tag (è®¤è¯æ ‡ç­¾)
    â†“
åŠ å¯†è¡¥ä¸ (patch.enc)
    â”œâ”€â”€ Header: [IV][Auth Tag]
    â””â”€â”€ Body: [Encrypted Data]
```

### 3. é˜²ç¯¡æ”¹æœºåˆ¶

```
åº”ç”¨è¡¥ä¸æ—¶:
    â†“
[è®¡ç®— SHA-256]
    â””â”€â”€ ä¿å­˜åˆ°åŠ å¯†å­˜å‚¨
    â†“
æ¯æ¬¡å¯åŠ¨æ—¶:
    â†“
[é‡æ–°è®¡ç®— SHA-256]
    â†“
[æ¯”å¯¹å“ˆå¸Œå€¼]
    â”œâ”€â”€ âœ… åŒ¹é… â†’ æ­£å¸¸åŠ è½½
    â””â”€â”€ âŒ ä¸åŒ¹é… â†’ è‡ªåŠ¨æ¢å¤
        â†“
    [ä»åŠ å¯†å­˜å‚¨æ¢å¤]
        â”œâ”€â”€ æ¢å¤æˆåŠŸ â†’ ç»§ç»­
        â””â”€â”€ æ¢å¤å¤±è´¥ â†’ æ¸…é™¤è¡¥ä¸
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. è¡¥ä¸ç”Ÿæˆä¼˜åŒ–

- **å¹¶è¡Œå¤„ç†**: å¤šçº¿ç¨‹å¤„ç†å¤šä¸ª DEX æ–‡ä»¶
- **å¢é‡ç®—æ³•**: BsDiff å‡å°‘è¡¥ä¸å¤§å°
- **Native åŠ é€Ÿ**: C/C++ å®ç°æ ¸å¿ƒç®—æ³•
- **æµå¼å¤„ç†**: é¿å…å¤§æ–‡ä»¶ OOM

### 2. è¡¥ä¸åº”ç”¨ä¼˜åŒ–

- **å»¶è¿ŸåŠ è½½**: éå…³é”®èµ„æºå»¶è¿ŸåŠ è½½
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜å·²è§£æçš„æ•°æ®
- **å†…å­˜ä¼˜åŒ–**: åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„èµ„æº
- **å¼‚æ­¥å¤„ç†**: åå°çº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œ

### 3. å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–

- **é¢„åŠ è½½**: Application.onCreate ä¸­é¢„åŠ è½½
- **æ‡’åŠ è½½**: æŒ‰éœ€åŠ è½½è¡¥ä¸å†…å®¹
- **ç¼“å­˜éªŒè¯**: ç¼“å­˜ç­¾åéªŒè¯ç»“æœ

---

## ğŸ”§ æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶åŒ–æ¶æ„

```java
interface PatchPlugin {
    void onBeforePatch(PatchInfo info);
    void onAfterPatch(PatchResult result);
    void onError(Exception e);
}

// æ³¨å†Œæ’ä»¶
HotUpdateHelper.getInstance()
    .registerPlugin(new LogPlugin())
    .registerPlugin(new MonitorPlugin())
    .registerPlugin(new CrashReportPlugin());
```

### 2. è‡ªå®šä¹‰å¼•æ“

```java
interface PatchEngine {
    boolean isAvailable();
    PatchResult generate(ApkInfo base, ApkInfo target);
}

// æ³¨å†Œè‡ªå®šä¹‰å¼•æ“
PatchGenerator.Builder()
    .customEngine(new MyCustomEngine())
    .build();
```

### 3. å›è°ƒæ‰©å±•

```java
interface PatchCallback {
    void onProgress(int percent, String message);
    void onSuccess(PatchResult result);
    void onError(String message);
}

// æ”¯æŒå¤šä¸ªå›è°ƒ
HotUpdateHelper.getInstance()
    .addCallback(callback1)
    .addCallback(callback2)
    .applyPatch(patchFile);
```

---

## ğŸ“ è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
3. **ä¾èµ–å€’ç½®**: ä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°
4. **æ¥å£éš”ç¦»**: æ¥å£æœ€å°åŒ–ï¼Œé¿å…è‡ƒè‚¿
5. **ç»„åˆä¼˜äºç»§æ‰¿**: ä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿

---

## ğŸ¯ æœªæ¥è§„åˆ’

1. **æ’ä»¶åŒ–æ”¯æŒ**: åŠ¨æ€åŠ è½½æ’ä»¶
2. **ç»„ä»¶åŒ–æ”¯æŒ**: æ¨¡å—åŒ–çƒ­æ›´æ–°
3. **è·¨å¹³å°æ”¯æŒ**: Flutterã€React Native
4. **äº‘ç«¯é›†æˆ**: CDNã€æ¨é€é€šçŸ¥
5. **AI ä¼˜åŒ–**: æ™ºèƒ½å·®å¼‚åˆ†æã€è‡ªåŠ¨å›æ»š

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Android ClassLoader æœºåˆ¶](https://source.android.com/docs/core/runtime/dex-format)
- [AssetManager æºç åˆ†æ](https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/content/res/AssetManager.java)
- [BsDiff ç®—æ³•è®ºæ–‡](http://www.daemonology.net/bsdiff/)
- [APK ç­¾åæœºåˆ¶](https://source.android.com/docs/security/features/apksigning)
